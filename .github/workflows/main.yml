name: Genicons CI

on:
  push:
    branches: [main]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: [3.8]
        poetry-version: [1.1.12]
        
    runs-on: ${{ matrix.os }}
    
    services:
      db:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: sample_db
          MYSQL_USER: user
          MYSQL_PASSWORD: password       # pragma: allowlist secret
          MYSQL_ROOT_PASSWORD: password  # pragma: allowlist secret
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
    steps:
      ## This DevSecOps pipeline exclude pre-commit hooking
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Poetry
        uses: abatilo/actions-poetry@v2.1.3
        with:
          poetry-version: ${{ matrix.poetry-version }}
      ## Unittest
      - name: Pytest
        run: |
          cd fastapi/
          poetry install --no-interaction
          poetry run pytest --rootdir=./app/test/ -c ./app/test/pytest.ini
      ## SAST (and dependency, infla-code, container-image)
      - name: Trivy
        uses: knqyf263/trivy-issue-action@v0.0.3

      ## Migration to "Staging" env

      ## DAST, Inflastructure scan

      ## Migration to "Production" env
      
      ## Monitoring, Guardrails
